%% Dimension line for LaTeX/TikZ
%% Copyright © 2013 Sébastien Gross  <seb•ɑƬ•chezwam•ɖɵʈ•org>
%%
%% This file may be distributed and/or modified
%%
%% 1. under the LaTeX Project Public License and/or
%% 2. under the WTF Public License.
%%
%%
%% This defines Tango scheme colors for LaTeX (see
%% http://tango.freedesktop.org).
%%
%% Please note that commands have been defined using letters instead of
%% numbers (ei. "Butter 1" -> butterA)
%%
%% You can use colors:
%%
%%  - directly:                      Colored \textcolor{butterA}{text} here.
%%  - by color name:                 Colored \butterA{text} here.
%%  - by color backgroung name:      Colored \BbutterA{text} here.
%%  - by beamer overlay:             Colored \butterA<2-3>{text} here.
%%  - by beamer background overlay:  Colored \BbutterA<2-3>{text} here.
%%  - by HTML code:                  Colored \textcolor{HTML}{\butter}{text} here.
%%
%% To install it copy the tango directory to either:
%%   - $TEXHOME/tex/latex/
%%   - ~/texmf/tex/latex/
%%   - ~/Library/texmf/tex/latex
%%

\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{tikz-dimline}[2013/03/13 v1.0 initial version]

\RequirePackage{tikz}
\RequirePackage{ifthen}

\usetikzlibrary{calc,decorations.markings,arrows}

\makeatletter



\pgfkeys {
  /dimline/.cd,
  execute style/.style = {#1},
  execute macro/.style = {/dimline/execute style/.expand once=#1},
}


\pgfarrowsdeclare{dimline}{dimline}
{
  \arrowsize=0.2\pgflinewidth
  \advance\arrowsize by .5\pgflinewidth
  \pgfarrowsleftextend{-4\arrowsize-.5\pgflinewidth}
  \pgfarrowsrightextend{6\pgflinewidth}
} {
  \arrowsize=0.2\pgflinewidth
  \advance\arrowsize by .5\pgflinewidth
  \pgfsetdash{}{0pt} %  do not dash
  % >
  % 2.885 by experience
  % Need a way to compute it exactely
  \pgfpathmoveto{\pgfpoint{2.885\pgflinewidth}{0pt}}
  \pgfpathlineto{\pgfpoint{-0\arrowsize}{1\arrowsize}}
  \pgfpathlineto{\pgfpoint{-0\arrowsize}{-1\arrowsize}}
  \pgfpathclose
  \pgfusepathqfillstroke
  % |
  \pgfpathmoveto{\pgfpoint{5.5\pgflinewidth}{3\arrowsize}}
  \pgfpathlineto{\pgfpoint{5.5\pgflinewidth}{-3\arrowsize}}
  \pgfusepathqstroke
}



\pgfarrowsdeclare{dimline reverse}{dimline reverse}
{
  \arrowsize=0.2\pgflinewidth
  \advance\arrowsize by .5\pgflinewidth
  \pgfarrowsleftextend{-4\arrowsize-.5\pgflinewidth}
  \pgfarrowsrightextend{0\pgflinewidth}
} {
  \arrowsize=0.2\pgflinewidth
  \advance\arrowsize by .5\pgflinewidth
  \pgfsetdash{}{0pt} %  do not dash
  % |
  \pgfpathmoveto{\pgfpoint{-.5\pgflinewidth}{3\arrowsize}}
  \pgfpathlineto{\pgfpoint{-.5\pgflinewidth}{-3\arrowsize}}
  \pgfusepathqstroke
  % >
  % 2.885 by experience
  % Need a way to compute it exactely
  \pgfpathmoveto{\pgfpoint{2.115\pgflinewidth}{0pt}}
  \pgfpathlineto{\pgfpoint{5\pgflinewidth}{1\arrowsize}}
  \pgfpathlineto{\pgfpoint{5\pgflinewidth}{-1\arrowsize}}
  \pgfpathclose
  \pgfusepathqfillstroke
}


\newcommand{\dimline@do@nothing}[1]{#1}%

% #1: optional keys parameters
% #2: start point
% #3: end point
% #4: text
\newcommand{\dimline}[4][]{%

  \pgfplotsifinaxis{%
    \coordinate (a) at (axis cs: #2) {};
    \coordinate (b) at (axis cs: #3) {};
    \let\dimline@internal\pgfplotsextra%
  }{%
    \coordinate (a) at (#2) {};
    \coordinate (b) at (#3) {};
    %\def\dimline@internal#1{#1}%
    \let\dimline@internal\dimline@do@nothing%
  }%



  \dimline@internal{
    \pgfkeys{
      %/dimline/.cd,
      dimline/.is family,
      dimline,
      color/.initial = black,
      extension start length/.initial=1cm,
      extension end length/.initial=1cm,
      extension start angle/.initial=-90,
      extension end angle/.initial=90,
      line style/.initial = {},
      label style/.initial = {},
      extension style/.initial = {},
      extension start style/.initial = {},
      extension end style/.initial = {},
      #1,
      line style/.get = \dimline@line@style,
      label style/.get = \dimline@label@style,
      extension style/.get = \dimline@extension@style,
      extension start style/.get = \dimline@extension@start@style,
      extension end style/.get = \dimline@extension@end@style,
    }


    \begin{scope} [
      line/.style = {
        color=\pgfkeysvalueof{/dimline/color},arrows=dimline-dimline,
        /dimline/execute macro = \dimline@line@style,
      },
      extension/.style = {
        color=\pgfkeysvalueof{/dimline/color}!40, line width=0.01,
        /dimline/execute macro = \dimline@extension@style,
      },
      extension start/.style = {
        extension,
        /dimline/execute macro = \dimline@extension@start@style
      },
      extension end/.style = {
        extension,
        /dimline/execute macro = \dimline@extension@end@style,
      },
      label/.style = {
        fill=white, align=center, sloped=true, pos=0.5,
        /dimline/execute macro = \dimline@label@style
      },
      ]

      \coordinate (a to b) at ($(a)!\pgfkeysvalueof{/dimline/extension start length}!\pgfkeysvalueof{/dimline/extension start angle}:(b)$);
      \coordinate (b to a) at ($(b)!\pgfkeysvalueof{/dimline/extension end length}!\pgfkeysvalueof{/dimline/extension end angle}:(a)$);

      \draw [extension start] (a.center) -- (a to b);
      \draw [extension end] (b.center) -- (b to a);

      \draw[line] (a.center) -- (b.center) node[label] {#4};
    \end{scope}
  }
}



\@ifclassloaded{beamer}{%
  \renewcommand<>{\dimline}[4][]{\only#5{\beameroriginal{\dimline}[#1]{#2}{#3}{#4}}}
}
\makeatother


\endinput
%% tikz-dimline.sty ends here.

